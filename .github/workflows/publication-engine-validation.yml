---
name: publication-engine-validation

on:
  pull_request:
    paths:
      - "lab/**"
      - ".github/workflows/publication-engine-validation.yml"
  push:
    paths:
      - "lab/**"
      - ".github/workflows/publication-engine-validation.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Validate network-free imports
        shell: bash
        run: |
          set -euo pipefail
          echo "Validating publication_engine.py is network-free..."
          
          # List of prohibited network libraries
          prohibited='(urllib|requests|http\.client|socket|aiohttp|httpx|ftplib|smtplib|telnetlib|xmlrpc)'
          
          if grep -E "^import ($prohibited)" lab/publication_engine.py; then
            echo "::error::Prohibited network import detected in publication_engine.py"
            exit 1
          fi
          
          if grep -E "^from ($prohibited)" lab/publication_engine.py; then
            echo "::error::Prohibited network import detected in publication_engine.py"
            exit 1
          fi
          
          echo "✓ No network imports detected"

      - name: Run publication engine
        shell: bash
        run: |
          set -euo pipefail
          echo "Running publication engine..."
          python3 lab/publication_engine.py 2026-02-06

      - name: Validate output structure
        shell: bash
        run: |
          set -euo pipefail
          echo "Validating output structure..."
          
          output_dir="lab/publication/claim-001/2026-02-06"
          
          # Check required files exist
          required_files=(
            "manifest.json"
            "sha256sum.txt"
            "provenance.json"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$output_dir/$file" ]; then
              echo "::error::Required file missing: $file"
              exit 1
            fi
            echo "✓ Found: $file"
          done
          
          # Check required directories exist
          required_dirs=(
            "tables"
            "derived"
          )
          
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$output_dir/$dir" ]; then
              echo "::error::Required directory missing: $dir"
              exit 1
            fi
            echo "✓ Found: $dir/"
          done

      - name: Validate provenance block
        shell: bash
        run: |
          set -euo pipefail
          echo "Validating provenance block..."
          
          provenance_file="lab/publication/claim-001/2026-02-06/provenance.json"
          
          # Check required fields exist
          required_fields=(
            "schema_version"
            "engine_version"
            "claim_id"
            "timestamp_utc"
            "determinism_statement"
            "inputs"
            "outputs"
            "verification"
          )
          
          for field in "${required_fields[@]}"; do
            if ! jq -e ".$field" "$provenance_file" > /dev/null; then
              echo "::error::Missing required field in provenance: $field"
              exit 1
            fi
            echo "✓ Found field: $field"
          done
          
          # Validate verification flags
          network_free=$(jq -r '.verification.network_free' "$provenance_file")
          deterministic=$(jq -r '.verification.deterministic' "$provenance_file")
          verified_inputs=$(jq -r '.verification.verified_inputs_only' "$provenance_file")
          
          if [ "$network_free" != "true" ]; then
            echo "::error::Provenance must declare network_free=true"
            exit 1
          fi
          
          if [ "$deterministic" != "true" ]; then
            echo "::error::Provenance must declare deterministic=true"
            exit 1
          fi
          
          if [ "$verified_inputs" != "true" ]; then
            echo "::error::Provenance must declare verified_inputs_only=true"
            exit 1
          fi
          
          echo "✓ All verification flags are true"

      - name: Validate manifest consistency
        shell: bash
        run: |
          set -euo pipefail
          echo "Validating manifest consistency..."
          
          output_dir="lab/publication/claim-001/2026-02-06"
          
          # Verify SHA256 checksums
          cd "$output_dir"
          sha256sum -c sha256sum.txt
          
          echo "✓ All SHA256 checksums verified"
          
          # Verify manifest.json contains all files
          file_count=$(jq '.files | length' manifest.json)
          echo "Manifest contains $file_count files"
          
          if [ "$file_count" -lt 1 ]; then
            echo "::error::Manifest should contain at least 1 file"
            exit 1
          fi
          
          echo "✓ Manifest contains file entries"

      - name: Test deterministic re-run
        shell: bash
        run: |
          set -euo pipefail
          echo "Testing deterministic re-run..."
          
          # Save first run hashes
          cp lab/publication/claim-001/2026-02-06/sha256sum.txt /tmp/sha256sum_run1.txt
          
          # Run again
          python3 lab/publication_engine.py 2026-02-06
          
          # Compare file hashes (excluding timestamp-dependent manifest/provenance)
          echo "Comparing table and derived artifact hashes..."
          
          # Extract and compare table hashes
          grep "tables/" /tmp/sha256sum_run1.txt | sort > /tmp/tables_run1.txt
          grep "tables/" lab/publication/claim-001/2026-02-06/sha256sum.txt | sort > /tmp/tables_run2.txt
          
          if ! diff /tmp/tables_run1.txt /tmp/tables_run2.txt; then
            echo "::error::Table hashes differ between runs (not deterministic)"
            exit 1
          fi
          
          echo "✓ Table outputs are deterministic"
          
          # Extract and compare derived artifact hashes
          grep "derived/" /tmp/sha256sum_run1.txt | sort > /tmp/derived_run1.txt
          grep "derived/" lab/publication/claim-001/2026-02-06/sha256sum.txt | sort > /tmp/derived_run2.txt
          
          if ! diff /tmp/derived_run1.txt /tmp/derived_run2.txt; then
            echo "::error::Derived artifact hashes differ between runs (not deterministic)"
            exit 1
          fi
          
          echo "✓ Derived outputs are deterministic"
          echo "✓ Deterministic re-run validation passed"

      - name: Validate input source
        shell: bash
        run: |
          set -euo pipefail
          echo "Validating input source..."
          
          provenance_file="lab/publication/claim-001/2026-02-06/provenance.json"
          
          # Check ledger path points to verified source
          ledger_path=$(jq -r '.inputs.ledger_path' "$provenance_file")
          
          if [[ ! "$ledger_path" =~ data/publish/3i-atlas ]]; then
            echo "::error::Ledger path must be data/publish/3i-atlas (verified source)"
            exit 1
          fi
          
          echo "✓ Input source is verified ledger"
          
          # Check input hashes are present
          hash_count=$(jq '.inputs.input_hashes | length' "$provenance_file")
          
          if [ "$hash_count" -lt 1 ]; then
            echo "::error::Provenance must include input hashes"
            exit 1
          fi
          
          echo "✓ Input hashes present ($hash_count files)"

      - name: Summary
        if: success()
        run: |
          echo "=========================================="
          echo "✓ All validation checks passed!"
          echo "=========================================="
          echo ""
          echo "Validated:"
          echo "  - Network-free imports"
          echo "  - Output structure"
          echo "  - Provenance blocks"
          echo "  - Manifest consistency"
          echo "  - Deterministic re-run"
          echo "  - Verified input source"
          echo ""
          echo "Publication engine is ready for use."
